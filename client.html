<!DOCTYPE html>
<html>
<head>
	<title>Node.js Ramshackle Web Chat v0.1</title>
	<link rel="stylesheet" href="res/css/bootstrap.css">
	<!-- Include the socket.io javascript on the client side -->
	<script src="res/sockjs-0.3.2.min.js"></script>
	<script src="http://code.jquery.com/jquery-1.7.1.min.js"></script>
	<style>
		span.connect{ color: blue; font-weight:bold; }
		span.disconnect{ color: red; font-weight:bold; }
		span.whisper{ color: purple; font-weight:bold; }
		span.emote { color: teal; font-style:italic; }
		span.system { color: gray; font-style:italic; }
		.me { background-color: #ddddff; }
		#chat_history {
			height:400px;
			overflow: scroll;
		}
		#msg-input {
			width: 780px;
		}
	</style>
</head>
	<body>
	<div class="container">
		<div class="row">
			<div class="span10">
				<h1>Ramshackle Chat v0.1</h1>
				<div id="chat_history">
					<ul id="broadcast-msg"></ul>
				</div>
			 
				<label for="msg-input">Chat Message</label>
				<input id="msg-input" name="msg-input" type="textarea" size="50" />
				<p>Press enter to submit your message</p>
	 		</div>
			<div class="span2">
				<h2>Members</h2>
				<table id="chat_members" class="table table-bordered">
				<tbody>
				<th>Nickname</th>
				</tbody>
				</table>
			</div>
	 	</div> <!-- row -->
	 
	 
		<script>
		  // Establish the connection with the server
		  var sockjs_url = 'http://localhost:8000/sockjs';
		  var sock = new SockJS(sockjs_url);
		  var myNickname = '';


		  // messaging protocol
		  var MESSAGE_TYPES = ['chat', 'set_nickname', 'whisper', 'emote'];
		  var CMD_MESSAGES = ['whisper', 'emote'];
		  var CMD_REGEX = [ (/(^\/w)|(^\/whisper)/i), (/(^\/e)|(^\/emote)/i)];
		  var CMD_ARGS_NUM = [ 3, 2 ];

		  function Message(type, content, target) {
		  	this.msg_type = type;
			this.content = content;
			this.target = target;
		  }
		  var M = Message.prototype;

		  // send JSON msg
		  function send(msg) {
			sock.send(JSON.stringify(msg));
		  }
		  // end messaging protocol
	 
		  function addMemberToList(name) {
			  $("#chat_members > tbody").append('<tr id="member_'+ name +'" style="display:none"><td>' + name + '</td></tr>');
			  if (name == myNickname) {
				  $("#member_" + name).addClass("info");
			  }
			  $("#member_" + name).fadeIn("fast");
		  }
		  function displayChatMessage(displayMessage) {
			if (displayMessage) {
				displayMessage = '<li>' + displayMessage + '</li>';
				$('#broadcast-msg').append(displayMessage);
				$('#chat_history').scrollTop($('#chat_history').height());
			}
		  }
		  function createCommandMessage(type, cmdArgs, content) {
		  	var toSend = null;
			switch(type) {
				case 'whisper':
					// TODO: validate target; handle case-insensitive.
					if (myNickname != cmdArgs[1]) {
						toSend = new Message(type, content, cmdArgs[1]);
					} else {
						displayChatMessage('<span class="system">You can\'t whisper to yourself!</span>');
					}
					break;
				case 'emote':
					toSend = new Message(type, content);
					break;
				default:
					console.log('Unknown command: ' + cmdArgs[0]);
					break;
			}
			return toSend;

		  }
		  function parseMessageToSend(txt) {
			  // FIXME: using tokenization split/join is ineffcient for messages with a lot of spaces.  Better to use an indexOf means instead.
			  var tokens = txt.split(" ");
			  // handle commands - examine first token for command escape
			  if (tokens.length > 0 && (/^\//).test(tokens[0])) {
			  	var command = null;
				var content = null;
			  	for (var i=0; i<CMD_MESSAGES.length; i++) {
					if (CMD_REGEX[i].test(tokens[0]) && tokens.length >= CMD_ARGS_NUM[i]) {
						command = tokens.splice(0, CMD_ARGS_NUM[i]-1);
						content = tokens.join(" ");
						var toSend = createCommandMessage(CMD_MESSAGES[i], command, content);
						if (toSend) {
							send(toSend);
						}
						break;
					}
				}
				if (!command) {
					displayChatMessage('<span class="system">Unknown command/invalid syntax for command "' + tokens[0] + '"</span>');
				}
			  } else {
			  	// general chat
			    send(new Message('chat', txt));
			  }

		  }

		  // on every message recived we print the new datas inside the #broadcast-msg div
		  sock.onmessage = function(message) {
			var data = message.data;
			console.log('Get broadcasted msg:', data);
			var chatMsg = JSON.parse(message.data);
			var displayMessage = '';
			switch(chatMsg.msg_type) {
				case 'connect':
					displayMessage = '<span class="connect"><b>' + chatMsg.nickname + '</b> joined the chat.</span>';
					if (myNickname == '') {
						// if I went in anon, use server assigned name
						myNickname = chatMsg.nickname;
					}
					addMemberToList(chatMsg.nickname);
					break;
				case 'members':
					for(var i in chatMsg.content) {
						addMemberToList(chatMsg.content[i]);
					}
					break;
				case 'chat':
					displayMessage = '<b>' + chatMsg.nickname + '</b>: ' + chatMsg.content +'';
					break;
				case 'whisper':
					if (myNickname == chatMsg.nickname) {
						displayMessage = '<span class="whisper">You whisper to <b>' + chatMsg.target + '</b></span>: ' + chatMsg.content +'';
					} else {
						displayMessage = '<span class="whisper"><b>' + chatMsg.nickname + '</b> whispers</span>: ' + chatMsg.content +'';
					}
					break;
				case 'emote':
					displayMessage = '<span class="emote"><b>' + chatMsg.nickname + '</b> ' + chatMsg.content +'</span>';
					break;
				case 'disconnect':
					displayMessage = '<span class="disconnect"><b>' + chatMsg.nickname + '</b> left the chat.</span>';
					$("#member_" + chatMsg.nickname).fadeOut("slow", function() { $("#member_" + chatMsg.nickname).remove() } );
					break;
				default:
					console.log('Unknown message type, ignorning');
			}
			displayChatMessage(displayMessage);
		  };
	 
		  // Create a new socket connection
		  sock.onopen = function() {
			myNickname = prompt('What is your nickname?');
			send(new Message('set_nickname', myNickname));
	 
			$('#msg-input').change( function(){
			  var txt = $(this).val().trim();
			  $(this).val('');
			  parseMessageToSend(txt);
			});
		  };

		  // connection closed
		  sock.onclose = function() {alert('Connection to the Chat Server was closed');};
		</script>
	</div>
	</body>
</html>
