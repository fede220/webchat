<!DOCTYPE html>
<html>
<head>
	<title>Node.js Ramshackle Web Chat v0.1</title>
	<link rel="stylesheet" href="res/css/bootstrap.css">
	<!-- Include the socket.io javascript on the client side -->
	<script src="res/sockjs-0.3.2.min.js"></script>
	<script src="http://code.jquery.com/jquery-1.7.1.min.js"></script>
	<style>
		span.connect{ color: blue; font-weight:bold; }
		span.disconnect{ color: red; font-weight:bold; }
		span.whisper{ color: purple; font-weight:bold; }
		.me { background-color: #ddddff; }
		#chat_history {
			height:400px;
			overflow: scroll;
		}
		#msg-input {
			width: 780px;
		}
	</style>
</head>
	<body>
	<div class="container">
		<div class="row">
			<div class="span10">
				<h1>Ramshackle Chat v0.1</h1>
				<div id="chat_history">
					<ul id="broadcast-msg"></ul>
				</div>
			 
				<label for="msg-input">Chat Message</label>
				<input id="msg-input" name="msg-input" type="textarea" size="50" />
				<p>Press enter to submit your message</p>
	 		</div>
			<div class="span2">
				<h2>Members</h2>
				<table id="chat_members" class="table table-bordered">
				<tbody>
				<th>Nickname</th>
				</tbody>
				</table>
			</div>
	 	</div> <!-- row -->
	 
	 
		<script>
		  // Establish the connection with the server
		  var sockjs_url = 'http://localhost:8000/sockjs';
		  var sock = new SockJS(sockjs_url);
		  var myNickname = '';
	 
		  // send JSON msg
		  function send(type, msg, target) {
			var toSend = {
				msg_type: type,
				content: msg,
				target: target
			};
			sock.send(JSON.stringify(toSend));
		  }
		  function addMemberToList(name) {
			  $("#chat_members > tbody").append('<tr id="member_'+ name +'" style="display:none"><td>' + name + '</td></tr>');
			  if (name == myNickname) {
				  $("#member_" + name).addClass("me");
			  }
			  $("#member_" + name).fadeIn("fast");
		  }

		  // on every message recived we print the new datas inside the #broadcast-msg div
		  sock.onmessage = function(message) {
			var data = message.data;
			console.log('Get broadcasted msg:', data);
			var chatMsg = JSON.parse(message.data);
			var displayMessage = '';
			switch(chatMsg.msg_type) {
				case 'connect':
					displayMessage = '<span class="connect"><b>' + chatMsg.nickname + '</b> joined the chat.</span>';
					if (myNickname == '') {
						// if I went in anon, use server assigned name
						myNickname = chatMsg.nickname;
					}
					addMemberToList(chatMsg.nickname);
					break;
				case 'members':
					for(var i in chatMsg.content) {
						addMemberToList(chatMsg.content[i]);
					}
					break;
				case 'chat':
					displayMessage = '<b>' + chatMsg.nickname + '</b>: ' + chatMsg.content +'';
					break;
				case 'whisper':
					if (myNickname == chatMsg.nickname) {
						displayMessage = '<span class="whisper">You whisper to <b>' + chatMsg.target + '</b></span>: ' + chatMsg.content +'';
					} else {
						displayMessage = '<span class="whisper"><b>' + chatMsg.nickname + '</b> whispers</span>: ' + chatMsg.content +'';
					}
					break;
				case 'disconnect':
					displayMessage = '<span class="disconnect"><b>' + chatMsg.nickname + '</b> left the chat.</span>';
					$("#member_" + chatMsg.nickname).fadeOut("slow", function() { $("#member_" + chatMsg.nickname).remove() } );
					break;
				default:
					console.log('Unknown message type, ignorning');
			}
			if (displayMessage) {
				displayMessage = '<li>' + displayMessage + '</li>';
				$('#broadcast-msg').append(displayMessage);
				$('#chat_history').scrollTop($('#chat_history').height());
			}
		  };
	 
		  // Create a new socket connection
		  sock.onopen = function() {
			myNickname = prompt('What is your nickname?');
			send('set_nickname', myNickname);
	 
			$('#msg-input').change( function(){
			  var txt = $(this).val().trim();
			  $(this).val('');
			  // handle special commands - examine first token
			  var tokens = txt.split(" ");
			  if (tokens.length > 0 && (/^\//).test(tokens[0])) {
			  	// whisper
				if ((/(^\/w)|(^\/whisper)/i).test(tokens[0]) && tokens.length >= 3) {
					var next = 0;
					var last = 0;
					for (var i = 0; i < 2; i++) {
						last = next;
						next = txt.indexOf(" ", last)+1;
					}
				  send('whisper', txt.substring(next), tokens[1]);
				}
			  } else {
			  	// general chat
			    send('chat', txt);
			  }
			});
		  };

		  // connection closed
		  sock.onclose = function() {alert('Connection to the Chat Server was closed');};
		</script>
	</div>
	</body>
</html>
