<!DOCTYPE html>
<html>
<head>
	<title>Node.js Ramshackle Web Chat v0.1</title>
	<meta charset="UTF-8">
	<link rel="stylesheet" href="res/css/bootstrap.css">
	<!-- Include the socket.io javascript on the client side -->
	<script src="res/sockjs-0.3.2.min.js"></script>
	<script src="http://code.jquery.com/jquery-1.7.1.min.js"></script>
	<script src="res/js/bootstrap.min.js"></script>
	<style>
		span.connect{ color: blue; font-weight:bold; }
		span.disconnect{ color: red; font-weight:bold; }
		span.whisper{ color: purple; font-weight:bold; }
		span.emote { color: teal; font-style:italic; }
		span.system { color: gray; font-style:italic; }

		.me { background-color: #ddddff; }
		#chatContainer.disabled { background-color: #dddddd; }
		#chatContainer {
			height:400px;
			overflow-y: scroll;
			overflow-x: hidden;
		}
		#chatMessageInput {
			width: 780px;
		}

		#chatLog {
			width:100%;
		}
		#chatLog td {
			border: none;
		}

		#chatLog td.timestamp {
			width: 80px;
			overflow: hidden;
		}
	</style>
</head>
<body>
	<div class="container">
		<div class="row">
			<div class="span10">
				<h1>Ramshackle Chat v0.1</h1>
				<div id="chatContainer" class="disabled">
					<a id="loginButton" href="#login" role="button" class="btn" data-toggle="modal">Join Chat!</a>
					<table id="chatLog" class="table table-hover">
					<tbody>
					</tbody>
					</table>
				</div>
			 
				<label for="chatMessageInput">Chat Message</label>
				<input id="chatMessageInput" name="chatMessageInput" type="textarea" size="50" />
				<p>Press enter to submit your message</p>
	 		</div>
			<div class="span2">
				<h2>Members</h2>
				<table id="chat_members" class="table table-bordered">
				<tbody>
				<th></th><th>Nickname</th>
				</tbody>
				</table>
			</div>
	 	</div> <!-- row -->
	 
	 
		<script>
		  // Establish the connection with the server
		  var sockjs_url = 'http://localhost:8000/sockjs';
		  var sock = null;
		  var chatMembers = [];
		  var nameMemberLookup = {};
		  var myClient = null;


		  // messaging protocol
		  var MESSAGE_TYPES = ['chat', 'set_nickname', 'whisper', 'emote', 'kick'];
		  var CMD_MESSAGES = ['whisper', 'emote', 'kick', 'mute'];
		  var CMD_REGEX = [ (/(^\/w)|(^\/whisper)/i), (/(^\/e)|(^\/emote)/i), (/(^\/k)|(^\/kick)/i),  (/(^\/m)|(^\/mute)/i)];
		  var CMD_ARGS_NUM = [ 3, 2, 2, 2 ];

		  function Message(type, content, target) {
		  	this.msg_type = type;
			this.content = content;
			this.target = target;
		  }
		  var M = Message.prototype;

		  // send JSON msg
		  function send(msg) {
			sock.send(JSON.stringify(msg));
		  }
		  // end messaging protocol

		  function getTimestamp() {
		  	var d = new Date();
			var t = (d.getHours() >= 10 ? d.getHours() : "0" + d.getHours()) 
				+ ":" + (d.getMinutes() >= 10 ? d.getMinutes() : "0" + d.getMinutes())
				+ ":" + (d.getSeconds() >= 10 ? d.getSeconds() : "0" + d.getMinutes());
			return t;
		  }
	 
		  function addMember(client) {
		  	chatMembers[client.id] = client;
			nameMemberLookup[client.name.toLowerCase()] = client;
			var domId = 'client_' + client.id;
			var jqId = '#' + domId; 
			$("#chat_members > tbody").append('<tr id="'+ domId +'" class="memberRow" style="display:none"><td class="opts"></td><td>' + client.name + '</td></tr>');
			if (client.name == myClient.name) {
				$(jqId).addClass("info");
			}
			updateOpts(client);
			$(jqId).fadeIn("fast");
		  }
		  function removeMember(client) {
			  var jqId = '#client_' + client.id;
			  $(jqId).fadeOut("slow", function() { $(jqId).remove() } );
			  delete chatMembers[client.id];
			  delete nameMemberLookup[client.name.toLowerCase()];
		  }
		  // on connect/reconnect, reset member list
		  function clearMembers() {
			 $("#chat_members > tbody > tr.memberRow").remove();
		  }
		  function updateOpts(client) {
			var jqId = '#client_' + client.id;	// client's row
			var jqOptsId = jqId + " > td.opts";	// opts' row

			// process options flags:

			// Flag - op
			if (client.opts['op']) {
				// don't reflag if already OP
				if ($(jqOptsId + " > i.icon-asterisk").length <= 0) {
					$(jqOptsId).prepend('<i class="icon-asterisk" title="Op"></i> ');
					displayChatMessage('<span class="system"><b>' + client.name + '</b> is chatroom Op</span>');
				} 
			} else {
				$(jqOptsId + " > i.icon-asterisk").remove();
			}
			// Flag - mute
			if (client.opts['mute']) {
				$(jqOptsId).prepend('<i class="icon-minus" title="Op"></i> ');
			} else {
				$(jqOptsId + " > i.icon-minus").remove();
			}
		  }

		  // appends a new message to the chatlog
		  function displayChatMessage(displayMessage) {
			if (displayMessage) {
				var toShow = '<tr>';
				toShow += '<td class="timestamp">' + getTimestamp() + '</td>';
				toShow += '<td>' + displayMessage + '</td>';
				toShow += '</tr>';
				$('#chatLog > tbody').append(toShow);
				$('#chatContainer').scrollTop($('#chatContainer').height());
			}
		  }
		  function createCommandMessage(type, cmdArgs, content) {
		  	var toSend = null;
			switch(type) {
				case 'whisper':
					// validate target; client must exist.
					// translate name to target client ID
					console.log('to lookup: ' + cmdArgs[1].toLowerCase());
					var targetClient = nameMemberLookup[cmdArgs[1].toLowerCase()];
					if (targetClient && myClient.id != targetClient.id) {
						toSend = new Message(type, content, targetClient.id);
					} else {
						displayChatMessage('<span class="system">You can\'t ' + type + ' yourself!</span>');
					}
					break;
				case 'kick':
				case 'mute':
					var targetClient = nameMemberLookup[content.toLowerCase()];
					if (targetClient && myClient.id != targetClient.id) {
						toSend = new Message(type, content, targetClient.id);
					} else {
						displayChatMessage('<span class="system">You can\'t ' + type + ' yourself!</span>');
					}
					break;
				case 'emote':
					toSend = new Message(type, content);
					break;
				default:
					console.log('Unknown command: ' + cmdArgs[0]);
					break;
			}
			return toSend;

		  }
		  function parseMessageToSend(txt) {
			  // FIXME: using tokenization split/join is ineffcient for messages with a lot of spaces.  Better to use an indexOf means instead.
			  var tokens = txt.split(" ");
			  // handle commands - examine first token for command escape
			  if (tokens.length > 0 && (/^\//).test(tokens[0])) {
			  	var command = null;
				var content = null;
			  	for (var i=0; i<CMD_MESSAGES.length; i++) {
					if (CMD_REGEX[i].test(tokens[0]) && tokens.length >= CMD_ARGS_NUM[i]) {
						command = tokens.splice(0, CMD_ARGS_NUM[i]-1);
						content = tokens.join(" ");
						var toSend = createCommandMessage(CMD_MESSAGES[i], command, content);
						if (toSend) {
							send(toSend);
						}
						break;
					}
				}
				if (!command) {
					displayChatMessage('<span class="system">Unknown command/invalid syntax for command "' + tokens[0] + '"</span>');
				}
			  } else {
			  	// general chat
			    send(new Message('chat', txt));
			  }

		  }

		  // ** socket handler definition 

		  function handleSockMessage(message) {
			var data = message.data;
			console.log('Got new msg:', data);
			var chatMsg = JSON.parse(message.data);
			var displayMessage = '';
			switch(chatMsg.msg_type) {
				case 'connect':
					if (!myClient) {
						myClient = chatMsg.from;
					}
					break;
				case 'join':
					addMember(chatMsg.from);
					displayMessage = '<span class="connect"><b>' + chatMsg.from.name + '</b> joined the chat.</span>';
					break;
				case 'members':
					var clients = chatMsg.content;
					for(var i in clients) {
						addMember(clients[i]);
					}
					break;
				case 'chat':
					displayMessage = '<b>' + chatMsg.from.name + '</b>: ' + chatMsg.content +'';
					break;
				case 'whisper':
					if (myClient.name == chatMsg.from.name) {
						displayMessage = '<span class="whisper">You whisper to <b>' + chatMembers[chatMsg.target].name + '</b></span>: ' + chatMsg.content +'';
					} else {
						displayMessage = '<span class="whisper"><b>' + chatMsg.from.name + '</b> whispers</span>: ' + chatMsg.content +'';
					}
					break;
				case 'emote':
					displayMessage = '<span class="emote"><b>' + chatMsg.from.name + '</b> ' + chatMsg.content +'</span>';
					break;
				case 'disconnect':
					displayMessage = '<span class="disconnect"><b>' + chatMsg.from.name + '</b> left the chat.</span>';
					removeMember(chatMsg.from);
					break;
				case 'update':
					var clients = chatMsg.content;
					for(var i in clients) {
						updateOpts(clients[i]);
					}
					break;
				case 'system':
					displayChatMessage('<span class="system">' + chatMsg.content + '</span>');
					break;
				default:
					console.log('Unknown message type, ignorning');
			}
			displayChatMessage(displayMessage);
		  };
	 
		  // Create a new socket connection
		  function handleSockOpen() {
			var myNickname = $("#inputNickname").val();
			send(new Message('set_nickname', myNickname));
	 
			$('#chatMessageInput').change( function(){
			  var txt = $(this).val().trim();
			  $(this).val('');
			  parseMessageToSend(txt);
			});
		  };

		  // connection closed
		  function handleSockClose() {
			  $('#loginButton').show();
			  displayChatMessage('<span class="system">You have left the chat.</span>');
			  $('#chatContainer').addClass('disabled');
			  alert('Connection to the Chat Server was closed');
		  };

		  // ** END socket handler definition 

		  function login() {
			  clearMembers();
			  sock = new SockJS(sockjs_url);

			  sock.onmessage = handleSockMessage;
			  sock.onopen = handleSockOpen;
			  sock.onclose = handleSockClose;


			  $('#loginButton').hide();
			  $('#chatContainer').removeClass('disabled');
			  $('#login').modal('hide');
		  }
		</script>
	</div>

	<!-- Login Dialog -->
    <div id="login" class="modal hide fade">
		<div class="modal-header">
			<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
			<h3>Welcome to Ramshackle Chat</h3>
		</div>
		<div class="modal-body">
			<p>To join, please enter a nickname.</p>
			<form id="loginForm" name="loginForm" action="#">
				<label for="inputNickname">Nickname:</label>
				<input id="inputNickname" name="inputNickname"/>
			</form>
		</div>
		<div class="modal-footer">
			<button class="btn" data-dismiss="modal" aria-hidden="true">Cancel</button>
			<button class="btn btn-primary" onClick="login()">Join Chat!</a>
		</div>
    </div>
	</body>
</html>
